<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>历史问答记录</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .container {
        max-width: 800px;
        margin: 40px auto;
        font-family: Arial;
    }
    .record {
        background: #f9f9f9;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 6px;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .qa-line {
        display: flex;
        margin-bottom: 8px;
    }
    .qa-line .label {
        font-weight: bold;
        margin-right: 6px;
        width: 20px;
        flex-shrink: 0;
    }
    .qa-line .content {
        flex: 1;
        white-space: pre-wrap;
    }
    .qa-line .content.collapsed {
        overflow: hidden;
        max-height: 6.4em; /* 4 lines with line-height 1.6 */
    }
    .pagination {
        text-align: center;
        margin-top: 20px;
    }
    button {
        padding: 5px 15px;
        margin: 0 10px;
    }
    .markdown {
        line-height: 1.6;
    }
    .markdown h1, .markdown h2, .markdown h3 {
        margin: 10px 0 6px;
    }
    .markdown p {
        margin: 4px 0;
    }
  </style>
</head>
<body>
<div id="app" class="container">
  <h2>我的问答历史</h2>

  <div v-for="item in records" :key="item.questionId" class="record">
    <div class="qa-line">
      <div class="label">Q：</div>
      <div class="content markdown" :class="{collapsed: !item.expanded}" v-html="renderMarkdown(item.questionContent)"></div>
    </div>
    <div class="qa-line">
      <div class="label">A：</div>
      <div class="content markdown" :class="{collapsed: !item.expanded}" v-html="renderMarkdown(item.answerContent)"></div>
    </div>
    <div class="time" style="color: gray; font-size: 13px;">
      时间：{{ formatTime(item.createTime) }}
      <span style="margin-left:10px;color:blue;cursor:pointer" @click="item.expanded = !item.expanded">{{ item.expanded ? '收起' : '展开' }}</span>
    </div>
  </div>

  <div class="pagination" v-if="total > pageSize">
    <button @click="prevPage" :disabled="page === 1">上一页</button>
    第 {{ page }} 页
    <button @click="nextPage" :disabled="page * pageSize >= total">下一页</button>
  </div>
</div>

<script>
  new Vue({
      el: '#app',
      data: {
          records: [],
          total: 0,
          page: 1,
          pageSize: 5
      },
      created() {
          this.fetchHistory();
      },
      methods: {
          fetchHistory() {
              axios.get('/api/qa/history', {
                  params: { page: this.page, size: this.pageSize }
              }).then(res => {
                    if (res.data.code === 0) {
                        this.records = res.data.data.records.map(r => ({...r, expanded: false}));
                        this.total = res.data.data.total;
                    } else {
                      alert("加载失败：" + res.data.message);
                  }
              });
          },
          prevPage() {
              if (this.page > 1) {
                  this.page--;
                  this.fetchHistory();
              }
          },
          nextPage() {
              if (this.page * this.pageSize < this.total) {
                  this.page++;
                  this.fetchHistory();
              }
          },
          renderMarkdown(text) {
              return marked.parse(text || '');
          },
          formatTime(datetimeStr) {
            if (!datetimeStr) return '';
                const date = new Date(datetimeStr);
                const pad = n => n.toString().padStart(2, '0');
              return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ` +
                `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;}
      }
  });
</script>
</body>
</html>
