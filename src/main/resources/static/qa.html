<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        AI ÈóÆÁ≠îÂπ≥Âè∞
    </title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js">
    </script>
    <style>
        body { background: #f5f7fa; font-family: Arial, sans-serif; margin: 0;
        padding: 0; min-height: 100vh; overflow-y: scroll; } .qa-container { max-width:
        800px; margin: 60px auto; padding: 30px; min-height: 500px; background:
        #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        min-height: 600px; text-align: center; } .nav { text-align: right; margin-bottom:
        10px; font-size: 14px; } .nav a { margin-left: 12px; color: #007bff; text-decoration:
        none; } h2 { margin-bottom: 20px; } .user-info { font-size: 14px; color:
        #444; text-align: right; margin-bottom: 10px; } textarea { width: 100%;
        padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius:
        6px; resize: vertical; box-sizing: border-box; } button { margin-top: 16px;
        padding: 10px 24px; font-size: 16px; background-color: #007bff; color:
        white; border: none; border-radius: 6px; cursor: pointer; } .answer-box
        { margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius:
        10px; text-align: left; font-size: 16px; line-height: 1.6; color: #333;
        } .history-link { display: block; margin: 50px auto 0; font-size: 14px;
        color: #007bff; text-decoration: none; text-align: center; } .history-list
        { margin-top: 20px; text-align: left; } .history-item { background: #f4f4f4;
        padding: 12px; border-radius: 8px; margin-bottom: 12px; } .history-item
        h4 { margin: 0 0 5px; } .history-item small { color: gray; } .scroll-btns
        { position: fixed; right: 20px; bottom: 40px; display: flex; flex-direction:
        column; z-index: 1000; } .scroll-btns button { margin-top: 8px; width:
        36px; height: 36px; font-size: 18px; background-color: #007bff; color:
        #fff; border: none; border-radius: 50%; cursor: pointer; } .chat-history
        { text-align: left; margin-top: 20px; max-height: 500px; overflow-y: auto;
        } .msg { display: flex; margin-bottom: 16px; align-items: flex-start; }
        .msg.user { flex-direction: row; } .msg.assistant { flex-direction: row-reverse;
        } .sender { font-weight: bold; width: 60px; } .bubble { padding: 12px 16px;
        border-radius: 12px; max-width: 75%; background-color: #f1f3f5; line-height:
        1.6; } .msg.assistant .bubble { background-color: #e0f3ff; }
    </style>
</head>
<body>
<div id="app" class="qa-container">
    <div class="nav">
        <a href="history.html">
            ÂéÜÂè≤ËÆ∞ÂΩï
        </a>
        <a href="#" @click.prevent="logout">
            ÈÄÄÂá∫ÁôªÂΩï
        </a>
    </div>
    <div class="user-info">
        ÂΩìÂâçÁî®Êà∑Ôºö{{ currentUser.username || 'Êú™ÁôªÂΩï' }}
    </div>
    <h2>
        AI ÈóÆÁ≠îÂπ≥Âè∞
    </h2>
    <div class="chat-history">
        <div v-for="(msg, i) in messages" :key="i" :class="['msg', msg.role]">
					<span class="sender">
						{{ msg.role === 'user' ? 'QÔºö' : 'ü§ñÔºö' }}
					</span>
            <div class="bubble" v-html="renderMarkdown(msg.content)">
            </div>
        </div>
    </div>
    <!-- <div class="history-list" v-if="records.length">
    <div class="history-item" v-for="item in records" :key="item.questionId">
    <h4>QÔºö{{ item.questionContent }}</h4>
    <div v-html="renderMarkdown(item.answerContent)"></div>
    </div>
    </div>
    <div class="answer-box" v-if="answer">
    <h3>AI ÁöÑÂõûÁ≠îÔºö</h3>
    <div v-html="compiledAnswer"></div>
    </div>-->
    <textarea v-model="question" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÈóÆÈ¢ò..." rows="5" @keydown.enter.exact.prevent="askAI">
			</textarea>
    <br>
    <button @click="askAI" :disabled="loading">
        {{ loading ? "ÊèêÈóÆ‰∏≠..." : "ÊèêÈóÆ" }}
    </button>
</div>
<div class="scroll-btns">
    <button @click="scrollToTop" aria-label="ÂõûÂà∞È°∂ÈÉ®">
        ‚ñ≤
    </button>
    <button @click="scrollToBottom" aria-label="ÊªöÂä®Âà∞Â∫ïÈÉ®">
        ‚ñº
    </button>
</div>
<script>
    new Vue({
        el: '#app',
        data: {
            question: '',
            answer: '',
            loading: false,
            currentUser: {},
            conversationId: '',
            records: [],
            messages: []
        },
        computed: {
            compiledAnswer() {
                return marked.parse(this.answer || '');
            }
        },
        created() {
            const userStr = sessionStorage.getItem("user");
            if (!userStr) {
                alert("ËØ∑ÂÖàÁôªÂΩïÔºÅ");
                window.location.href = "/login.html";
                return;
            }
            this.currentUser = JSON.parse(userStr);
            this.fetchHistory();
        },
        methods: {
            askAI() {
                if (!this.question.trim()) {
                    alert("ËØ∑ËæìÂÖ•ÈóÆÈ¢òÔºÅ");
                    return;
                }
                this.loading = true;
                this.answer = "";

                this.messages.push({
                    role: 'user',
                    content: this.question
                });

                axios.post('/api/ai/ask', {
                    question: this.question,
                    conversationId: this.conversationId
                }).then(res =>{
                    if (res.data.code === 0) {
                        this.conversationId = res.data.data.conversationId;
                        const answer = res.data.data.answer;

                        this.messages.push({
                            role: 'assistant',
                            content: answer
                        });

                        this.question = '';
                        this.$nextTick(() =>{
                            this.scrollToBottom();
                        });
                        if (this.records.length > 5) {
                            this.records.shift();
                        }
                    } else {
                        this.messages.push({
                            role: 'assistant',
                            content: "Âá∫ÈîôÔºö" + res.data.msg
                        });
                    }
                }).
                catch(err =>{
                    this.messages.push({
                        role: 'assistant',
                        content: "ËØ∑Ê±ÇÂ§±Ë¥•Ôºö" + err.message
                    });
                }).
                finally(() =>{
                    this.loading = false;
                });
            },
            fetchHistory() {
                axios.get('/api/qa/history', {
                    params: {
                        page: 1,
                        size: 5
                    }
                }).then(res =>{
                    if (res.data.code === 0) {
                        this.records = res.data.data.records.reverse();
                    }
                });
            },
            renderMarkdown(text) {
                return marked.parse(text || '');
            },
            formatTime(ts) {
                return ts ? ts.replace("T", " ").slice(0, 19) : '';
            },
            scrollToBottom() {
                this.$nextTick(() =>{
                    const el = this.$el.querySelector(".chat-history");
                    if (el) el.scrollTop = el.scrollHeight;
                });
            },
            scrollToTop() {
                const el = this.$el.querySelector(".chat-history");
                if (el) el.scrollTop = 0;
            },
            logout() {
                axios.post('/api/user/logout').then(() =>{
                    sessionStorage.removeItem('user');
                    window.location.href = 'index.html';
                });
            }
        }
    });
</script>
</body>

</html>